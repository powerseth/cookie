<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vape Shop Mini App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 10px;
      background-color: #f0f0f0;
      color: #333;
    }
    h1 {
      font-size: 24px;
      text-align: center;
    }
    .vape-item {
      background: white;
      padding: 15px;
      margin: 10px 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .vape-item img {
      max-width: 150px;
      height: auto;
      border-radius: 8px;
      margin-bottom: 10px;
    }
    .vape-item h3 {
      margin: 0 0 10px;
      font-size: 18px;
      text-align: center;
    }
    .vape-item p {
      margin: 5px 0;
      font-size: 14px;
    }
    .vape-item select, .vape-item button {
      padding: 8px;
      margin: 5px 0;
      border-radius: 5px;
      border: 1px solid #ccc;
      width: 100%;
      max-width: 200px;
    }
    .vape-item select:disabled {
      background: #e0e0e0;
    }
    .vape-item button {
      background: #28a745;
      color: white;
      border: none;
      cursor: pointer;
    }
    .vape-item button:hover {
      background: #218838;
    }
    #cart {
      margin-top: 20px;
      padding: 15px;
      background: white;
      border-radius: 8px;
    }
    #cart h2 {
      font-size: 20px;
      margin: 0 0 10px;
    }
    #cart ul {
      list-style: none;
      padding: 0;
    }
    #cart li {
      margin: 5px 0;
      font-size: 14px;
    }
    #cart:empty {
      display: none;
    }
  </style>
</head>
<body>
  <h1>Vape Shop</h1>
  <div id="vape-list"></div>
  <div id="cart">
    <h2>Cart</h2>
    <ul id="cart-items"></ul>
    <p>Total: $<span id="cart-total">0.00</span></p>
  </div>

  <script>
    // Initialize Telegram Web App
    const WebApp = window.Telegram.WebApp;
    WebApp.ready();

    // Initialize cart
    let cart = [];

    // Load vapes from JSON
    fetch('vapes.json')
      .then(response => response.json())
      .then(vapes => {
        const vapeList = document.getElementById('vape-list');
        vapes.forEach((vape, index) => {
          const vapeDiv = document.createElement('div');
          vapeDiv.className = 'vape-item';
          const flavorOptions = vape.flavours.length > 0 
            ? vape.flavours.map(flavor => `<option value="${flavor}">${flavor}</option>`).join('')
            : '<option value="No Flavor">No Flavor Available</option>';
          const isFlavorDisabled = vape.flavours.length === 0 ? 'disabled' : '';
          vapeDiv.innerHTML = `
            <img src="${vape.image}" alt="${vape.name}">
            <h3>${vape.name}</h3>
            <p>Puffs: ${vape.puffs}</p>
            <p>Nicotine: ${vape.nicotine}</p>
            <p>Price: $${vape.price.toFixed(2)}</p>
            <select id="flavor-${index}" ${isFlavorDisabled}>
              ${flavorOptions}
            </select>
            <button onclick="addToCart(${index}, '${vape.name}', ${vape.price}, document.getElementById('flavor-${index}').value, ${vape.puffs}, '${vape.nicotine}')">Add to Cart</button>
          `;
          vapeList.appendChild(vapeDiv);
        });
      })
      .catch(error => console.error('Error loading vapes:', error));

    // Add to cart
    function addToCart(id, name, price, flavor, puffs, nicotine) {
      cart.push({ id, name, price, flavor, puffs, nicotine });
      updateCart();
    }

    // Update cart display
    function updateCart() {
      const cartItems = document.getElementById('cart-items');
      const cartTotal = document.getElementById('cart-total');
      cartItems.innerHTML = '';
      let total = 0;

      cart.forEach((item, index) => {
        const li = document.createElement('li');
        li.textContent = `${item.name} (${item.flavor}, ${item.puffs} Puffs, ${item.nicotine}) - $${item.price.toFixed(2)}`;
        cartItems.appendChild(li);
        total += item.price;
      });

      cartTotal.textContent = total.toFixed(2);

      // Update Telegram Main Button
      if (cart.length > 0) {
        WebApp.MainButton.text = 'Send Order';
        WebApp.MainButton.show();
        WebApp.MainButton.enable();
        WebApp.MainButton.onClick(sendOrder);
      } else {
        WebApp.MainButton.hide();
      }
    }

    // Send order to bot
    function sendOrder() {
      if (cart.length === 0) return;

      const orderDetails = cart.map(item => 
        `${item.name} (${item.flavor}, ${item.puffs} Puffs, ${item.nicotine}) - $${item.price.toFixed(2)}`
      ).join('\n');
      const total = cart.reduce((sum, item) => sum + item.price, 0).toFixed(2);
      const message = `New Order:\n${orderDetails}\n\nTotal: $${total}`;

      // Send data to bot
      WebApp.sendData(message);

      // Clear cart after sending
      cart = [];
      updateCart();
    }

    // Set Telegram theme
    WebApp.onEvent('themeChanged', () => {
      document.body.style.backgroundColor = WebApp.themeParams.bg_color || '#f0f0f0';
      document.body.style.color = WebApp.themeParams.text_color || '#333';
    });
  </script>
</body>
</html>
